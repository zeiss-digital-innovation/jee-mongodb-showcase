@using DotNetMapsFrontend.Constants
@model List<DotNetMapsFrontend.Models.PointOfInterest>
@{
    ViewData["Title"] = "Point of Interest List";
}

@section Styles {
    <link rel="stylesheet" href="~/css/poi-list.css" />
}

<!-- Apply view preference immediately to prevent flash -->
<script>
    (function() {
        const savedView = localStorage.getItem('poi_view');
        if (savedView === 'list') {
            // Inject CSS to show list view immediately
            const style = document.createElement('style');
            style.id = 'initial-view-style';
            style.textContent = '#poiCardsContainer { display: none !important; } #poiTableContainer { display: block !important; }';
            document.head.appendChild(style);
        }
    })();
</script>

<div class="top-controls fixed-top">
    <div class="container">
        <partial name="_PoiControls" />
    </div>
</div>

<!-- Fixed Header Section -->
<div class="poi-header-section">
    <div class="container">
        <h2 class="mb-3">Points of Interest</h2>
        <!-- View Toggle -->
        <div class="view-toggle">
            <div class="btn-group" role="group" aria-label="View toggle">
                <button type="button" class="btn btn-outline-primary active" id="cardsViewBtn">
                    <i class="bi bi-grid-3x3-gap me-1"></i>Cards
                </button>
                <button type="button" class="btn btn-outline-primary" id="listViewBtn">
                    <i class="bi bi-list-ul me-1"></i>List
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Scrollable Content Area -->
<div class="poi-scrollable-content">
    <div class="container">
        <!-- Cards View (Default) -->
        <div id="poiCardsContainer">
            <!-- Will be populated by JavaScript -->
        </div>
    
        <!-- Table View (List) -->
        <div id="poiTableContainer" style="display: none;">
            <!-- Will be populated by JavaScript -->
        </div>
    </div> <!-- End of container -->
</div> <!-- End of poi-scrollable-content -->

<!-- Edit POI Modal -->
<div class="modal fade modal-sm" id="editPoiModal" tabindex="-1" aria-labelledby="editPoiModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h6 class="modal-title" id="editPoiModalLabel">
                    <i class="bi bi-pencil-square me-2"></i>Edit Point of Interest
                </h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editPoiForm">
                    <input type="hidden" id="editPoiId">
                    
                    <div class="mb-3">
                        <label for="editPoiCategory" class="form-label">Category *</label>
                        <select class="form-select" id="editPoiCategory" required>
                            <option value="">-- Select Category --</option>
                        </select>
                        <div class="invalid-feedback">
                            Please select a category.
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="editPoiName" class="form-label">Name *</label>
                        <input type="text" class="form-control" id="editPoiName" 
                               placeholder="Enter a name for this point of interest..." 
                               required maxlength="200">
                        <div class="invalid-feedback">
                            Please enter a name (max 200 characters).
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="editPoiDetails" class="form-label">Details *</label>
                        <textarea class="form-control" id="editPoiDetails" rows="4" 
                                  placeholder="Enter details about this point of interest..." 
                                  required maxlength="1000"></textarea>
                        <div class="invalid-feedback">
                            Please enter details (max 1000 characters).
                        </div>
                        <div class="form-text">
                            You can use quotes, special characters, and line breaks.
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <small class="text-muted">
                             <i class="bi bi-geo-fill"></i> Location: <span id="editPoiCoordinates"></span>
                        </small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-warning btn-sm" data-bs-dismiss="modal" id="cancelEditBtn">
                    <i class="bi bi-x-lg me-1"></i>Cancel (Esc)
                </button>
                <button type="button" class="btn btn-primary btn-sm" id="saveEditBtn" disabled>
                    <i class="bi bi-check2 me-1"></i>Save (Enter)
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <!-- Category Manager - Shared module -->
    <script src="~/js/category-manager.js"></script>
    
    <script>

        // Define CATEGORY_ICONS before using it
        const CATEGORY_ICONS = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(CategoryConstants.GetIconMappingDictionary()));
        
        // Shared localStorage keys for synchronization with Map page
        const STORAGE_KEYS = {
            latitude: 'poi_latitude',
            longitude: 'poi_longitude',
            radius: 'poi_radius',
            view: 'poi_view',
            needsReload: 'poi_needs_reload',
            sessionStart: 'poi_session_start'
        };
        
        // Default coordinates (Dresden) - must match Map page
        const latitudeDefault = 51.0504;
        const longitudeDefault = 13.7373;
        const radiusDefault = 2000;
        
        // Session timeout: 30 minutes of inactivity = new session
        const SESSION_TIMEOUT_MS = 30 * 60 * 1000;
        
        // sorting state for table columns
        let currentSortColumn = null; // null, name or details
        let sortAscending = true;
        let currentTablePois = []; // current POI list for Sorting

        $(document).ready(async function() {
            // Initialize Category Manager FIRST
            await CategoryManager.init();
            
            // Listen for category selection changes
            document.addEventListener('categorySelectionChanged', function(e) {
                console.log('Category selection changed, reloading POIs...');
                reloadCurrentPois();
            });
            
            // Load initial POIs from server via AJAX
            loadInitialPois();
            
            // Check if this is a new browser session
            const lastActivity = localStorage.getItem(STORAGE_KEYS.sessionStart);
            const now = Date.now();
            const isNewSession = !lastActivity || (now - parseInt(lastActivity)) > SESSION_TIMEOUT_MS;
            
            if (isNewSession) {
                // This is a NEW session - clear settings but keep view preference
                localStorage.removeItem(STORAGE_KEYS.latitude);
                localStorage.removeItem(STORAGE_KEYS.longitude);
                localStorage.removeItem(STORAGE_KEYS.radius);
                localStorage.removeItem(STORAGE_KEYS.needsReload);
                localStorage.setItem(STORAGE_KEYS.view, 'cards');
            }
            
            // Update session timestamp
            localStorage.setItem(STORAGE_KEYS.sessionStart, now.toString());
            
            // View toggle functionality - load from localStorage or default to 'cards'
            let currentView = localStorage.getItem(STORAGE_KEYS.view) || 'cards';
            
            // Store original POI data for change detection
            let originalPoiData = {
                category: '',
                details: ''
            };
            
            // Apply saved view IMMEDIATELY to prevent flash
            applySavedView();
            
            // Load settings from localStorage on page load
            loadSettingsFromStorage();
            
            // Check if we need to reload POIs based on updates from Map page
            checkForUpdates();
            
            // Setup control event handlers for saving to localStorage
            setupControlHandlers();
            
            // Listen for page visibility changes to sync with Map page
            // This ensures input fields are updated when navigating back from Map page
            window.addEventListener('pageshow', function(event) {
                console.log('[List] pageshow event - reloading settings from localStorage');
                loadSettingsFromStorage();
            });
            
            // Also listen for focus events (when user returns to this tab)
            window.addEventListener('focus', function() {
                console.log('[List] window focus event - reloading settings from localStorage');
                loadSettingsFromStorage();
            });
            
            // Load categories for Edit Modal dropdown
            loadEditModalCategories();
            
            // Setup Edit Modal event handlers
            setupEditModalHandlers();
            
            function loadSettingsFromStorage() {
                // Load values from localStorage or use defaults
                const lat = localStorage.getItem(STORAGE_KEYS.latitude);
                const lon = localStorage.getItem(STORAGE_KEYS.longitude);
                const radius = localStorage.getItem(STORAGE_KEYS.radius);
                
                const actualLat = lat ? parseFloat(lat) : latitudeDefault;
                const actualLon = lon ? parseFloat(lon) : longitudeDefault;
                const actualRadius = radius ? parseInt(radius) : radiusDefault;
                
                // Set input fields to actual values
                $('#latitudeInput').val(actualLat);
                $('#longitudeInput').val(actualLon);
                $('#radiusInput').val(actualRadius);
                $('#radiusValue').text(actualRadius + ' m');
                
                // Save to localStorage if they were defaults (ensures consistency)
                if (!lat) localStorage.setItem(STORAGE_KEYS.latitude, actualLat);
                if (!lon) localStorage.setItem(STORAGE_KEYS.longitude, actualLon);
                if (!radius) localStorage.setItem(STORAGE_KEYS.radius, actualRadius);
            }
            
            function saveSettingsToStorage() {
                localStorage.setItem(STORAGE_KEYS.latitude, $('#latitudeInput').val());
                localStorage.setItem(STORAGE_KEYS.longitude, $('#longitudeInput').val());
                localStorage.setItem(STORAGE_KEYS.radius, $('#radiusInput').val());
                
                // Set flag that Map page needs to reload
                localStorage.setItem(STORAGE_KEYS.needsReload, 'true');
            }
            
            function checkForUpdates() {
                // Check if Map page triggered an update
                const needsReload = localStorage.getItem(STORAGE_KEYS.needsReload);
                const currentParams = new URLSearchParams(window.location.search);
                const urlLat = currentParams.get('lat');
                const urlLon = currentParams.get('lon');
                const urlRadius = currentParams.get('radius');
                
                // If needsReload flag is set and we don't have URL params, reload with stored values
                if (needsReload === 'true' && !urlLat && !urlLon) {
                    const lat = localStorage.getItem(STORAGE_KEYS.latitude);
                    const lon = localStorage.getItem(STORAGE_KEYS.longitude);
                    const radius = localStorage.getItem(STORAGE_KEYS.radius);
                    
                    if (lat && lon && radius) {
                        // Clear the reload flag and reload
                        localStorage.removeItem(STORAGE_KEYS.needsReload);
                        window.location.href = `/poi?lat=${lat}&lon=${lon}&radius=${radius}`;
                    }
                } else if (urlLat && urlLon) {
                    // We were loaded with URL params, clear the reload flag
                    localStorage.removeItem(STORAGE_KEYS.needsReload);
                }
            }
            
            function applySavedView() {
                // Remove the initial style tag if it exists (it was used to prevent flash)
                const initialStyle = document.getElementById('initial-view-style');
                if (initialStyle) {
                    initialStyle.remove();
                }
                
                // Apply the saved view preference
                if (currentView === 'list') {
                    $('#listViewBtn').addClass('active');
                    $('#cardsViewBtn').removeClass('active');
                    $('#poiCardsContainer').hide();
                    $('#poiTableContainer').show();
                } else {
                    $('#cardsViewBtn').addClass('active');
                    $('#listViewBtn').removeClass('active');
                    $('#poiCardsContainer').show();
                    $('#poiTableContainer').hide();
                }
            }
            
            function setupControlHandlers() {
                // Save to localStorage when inputs change
                $('#latitudeInput, #longitudeInput').on('change', function() {
                    saveSettingsToStorage();
                });
                
                // Update radius display and save to localStorage
                $('#radiusInput').on('input', function() {
                    $('#radiusValue').text($(this).val() + 'm');
                    saveSettingsToStorage();
                });
                
                // Load POIs button
                $('#loadPoisBtn').on('click', function() {
                    saveSettingsToStorage();
                    loadPois();
                });
            }
            
            function loadPois() {
                const lat = $('#latitudeInput').val();
                const lon = $('#longitudeInput').val();
                const radius = $('#radiusInput').val();
                
                // Update input fields to trigger storage save
                $('#latitudeInput').val(lat);
                $('#longitudeInput').val(lon);
                $('#radiusInput').val(radius);
                
                // Save to localStorage
                saveSettingsToStorage();
                
                // Clear reload flag (we're doing the reload now)
                localStorage.removeItem(STORAGE_KEYS.needsReload);
                
                // Reload POIs via AJAX instead of page reload
                reloadCurrentPois();
            }
            
            function loadInitialPois() {
                // Get coordinates from URL params or localStorage
                const urlParams = new URLSearchParams(window.location.search);
                const lat = urlParams.get('lat') || localStorage.getItem(STORAGE_KEYS.latitude) || latitudeDefault;
                const lon = urlParams.get('lon') || localStorage.getItem(STORAGE_KEYS.longitude) || longitudeDefault;
                const radius = urlParams.get('radius') || localStorage.getItem(STORAGE_KEYS.radius) || radiusDefault;
                
                // Get selected categories
                const selectedCategories = CategoryManager.getSelectedCategories();
                
                // Build request data
                const requestData = {
                    lat: parseFloat(lat),
                    lon: parseFloat(lon),
                    radius: parseInt(radius)
                };
                
                // Add category parameters
                selectedCategories.forEach((category, index) => {
                    requestData[`category[${index}]`] = category;
                });
                
                console.log('[List] Loading initial POIs with params:', requestData);
                
                // Load POIs via AJAX
                $.ajax({
                    url: '/api/pointsofinterest',
                    method: 'GET',
                    traditional: true,
                    data: requestData,
                    success: function(data) {
                        console.log(`[List] Loaded ${data.length} initial POIs`);
                        updatePoiCards(data);
                        updatePoiTable(data);
                    },
                    error: function(xhr, status, error) {
                        console.error('[List] Failed to load initial POIs:', error);
                        // Show error message in both containers
                        const errorHtml = `
                            <div class="alert alert-warning">
                                <i class="bi bi-exclamation-triangle me-2"></i>
                                Failed to load points of interest. Please try clicking "Load POIs".
                            </div>
                        `;
                        $('#poiCardsContainer').html(errorHtml);
                        $('#poiTableContainer').html(errorHtml);
                    }
                });
            }
            
            function loadEditModalCategories() {
                // Use categories from CategoryManager (already loaded)
                const categories = CategoryManager.getAllCategories();
                
                if (categories && categories.length > 0) {
                    populateEditModalCategoryDropdown(categories);
                } else {
                    // Fallback: load directly from API if CategoryManager failed
                    $.ajax({
                        url: '/api/categories',
                        type: 'GET',
                        success: function (categories) {
                            populateEditModalCategoryDropdown(categories);
                        },
                        error: function (xhr, status, error) {
                            console.warn('Could not load categories for edit modal:', error);
                        }
                    });
                }
            }
            
            function populateEditModalCategoryDropdown(categories) {
                const $categorySelect = $('#editPoiCategory');
                $categorySelect.empty();
                $categorySelect.append('<option value="">-- Select Category --</option>');
                
                categories.forEach(function (category) {
                    // Value and display text both lowercase
                    const lowerCategory = category.toLowerCase();
                    $categorySelect.append(`<option value="${lowerCategory}">${lowerCategory}</option>`);
                });
            }
            
            function setupEditModalHandlers() {
                // Enable/disable save button based on form validation and changes
                $('#editPoiCategory, #editPoiName, #editPoiDetails').on('input change', function () {
                    validateEditForm();
                });
                
                // Handle Save button click
                $('#saveEditBtn').click(function () {
                    if (validateEditForm() && hasChanges()) {
                        saveEditedPoi();
                    }
                });
                
                // Handle keyboard shortcuts
                $('#editPoiModal').on('keydown', function (e) {
                    if (e.key === 'Enter' && !e.shiftKey && e.target.tagName !== 'TEXTAREA') {
                        e.preventDefault();
                        if ($('#saveEditBtn').prop('disabled') === false) {
                            saveEditedPoi();
                        }
                    } else if (e.key === 'Escape') {
                        e.preventDefault();
                        bootstrap.Modal.getInstance(document.getElementById('editPoiModal')).hide();
                    }
                });
                
                // Allow Shift+Enter in textarea for new lines
                $('#editPoiDetails').on('keydown', function(e) {
                    if (e.key === 'Enter' && e.shiftKey) {
                        // Allow default behavior (new line)
                        return true;
                    } else if (e.key === 'Enter') {
                        e.preventDefault();
                        if ($('#saveEditBtn').prop('disabled') === false) {
                            saveEditedPoi();
                        }
                    }
                });
            }
            
            function validateEditForm() {
                const category = $('#editPoiCategory').val().trim();
                const name = $('#editPoiName').val().trim();
                const details = $('#editPoiDetails').val().trim();
                const isValid = category !== '' && name !== '' && details !== '';
                const changed = hasChanges();
                
                $('#saveEditBtn').prop('disabled', !isValid || !changed);
                
                return isValid;
            }
            
            function hasChanges() {
                const currentCategory = $('#editPoiCategory').val().trim();
                const currentName = $('#editPoiName').val().trim();
                const currentDetails = $('#editPoiDetails').val().trim();
                
                return currentCategory !== originalPoiData.category || 
                       currentName !== originalPoiData.name ||
                       currentDetails !== originalPoiData.details;
            }
            
            $('#cardsViewBtn').click(function() {
                currentView = 'cards';
                localStorage.setItem(STORAGE_KEYS.view, 'cards');
                $(this).addClass('active');
                $('#listViewBtn').removeClass('active');
                $('#poiCardsContainer').show();
                $('#poiTableContainer').hide();
            });
            
            $('#listViewBtn').click(function() {
                currentView = 'list';
                localStorage.setItem(STORAGE_KEYS.view, 'list');
                $(this).addClass('active');
                $('#cardsViewBtn').removeClass('active');
                $('#poiCardsContainer').hide();
                $('#poiTableContainer').show();
            });
            
            // Update radius display when slider changes
            $('#radiusInput').on('input', function() {
                $('#radiusValue').text($(this).val());
            });
            
            // Validate coordinates
            function validateCoordinates() {
                const lat = parseFloat($('#latitudeInput').val());
                const lon = parseFloat($('#longitudeInput').val());
                const radius = parseInt($('#radiusInput').val());
                
                const latValid = !isNaN(lat) && lat >= -90 && lat <= 90;
                const lonValid = !isNaN(lon) && lon >= -180 && lon <= 180;
                const radiusValid = !isNaN(radius) && radius >= 100 && radius <= 5000;
                
                return latValid && lonValid && radiusValid;
            }
            
            // Update button state based on validation
            function updateButtonState() {
                $('#loadPoisBtn').prop('disabled', !validateCoordinates());
            }
            
            $('#latitudeInput, #longitudeInput, #radiusInput').on('input', updateButtonState);
            updateButtonState();
            
            // Load POIs button click handler
            $('#loadPoisBtn').click(function() {
                const lat = parseFloat($('#latitudeInput').val());
                const lon = parseFloat($('#longitudeInput').val());
                const radius = parseInt($('#radiusInput').val());
                
                if (!validateCoordinates()) {
                    alert('Please enter valid coordinates and radius.');
                    return;
                }
                
                // Show loading state
                const $btn = $(this);
                const originalHtml = $btn.html();
                $btn.html('<span class="spinner-border spinner-border-sm me-1"></span>Loading...').prop('disabled', true);
                
                // Get selected categories
                const selectedCategories = CategoryManager.getSelectedCategories();
                
                // Build data object with categories
                const requestData = { 
                    lat: lat, 
                    lon: lon, 
                    radius: radius 
                };
                
                // Add category parameters (repeated parameter pattern)
                selectedCategories.forEach((category, index) => {
                    requestData[`category[${index}]`] = category;
                });
                
                console.log('Loading POIs with categories:', selectedCategories);
                
                // Make AJAX request
                $.ajax({
                    url: '/api/pointsofinterest',
                    method: 'GET',
                    traditional: true, // Important for array parameters
                    data: requestData,
                    success: function(data) {
                        console.log(`Loaded ${data.length} POIs`);
                        // Update both views with new data
                        updatePoiCards(data);
                        updatePoiTable(data);
                    },
                    error: function() {
                        alert('Failed to load points of interest. Please try again.');
                    },
                    complete: function() {
                        $btn.html(originalHtml).prop('disabled', false);
                        updateButtonState();
                    }
                });
            });
            
            // Make these functions available globally for reloadCurrentPois
            window.updatePoiCards = updatePoiCards;
            window.updatePoiTable = updatePoiTable;
            
            function updatePoiCards(pois) {
                const $container = $('#poiCardsContainer');
                
                if (!pois || pois.length === 0) {
                    $container.html(`
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle me-2"></i>
                            No points of interest found. Please adjust the search parameters and try again.
                        </div>
                    `);
                    return;
                }
                
                let cardsHtml = '<div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">';
                
                pois.forEach((poi) => {
                    const icon = getCategoryIcon(poi.category);
                    const details = formatDetails(poi.details);
                    const category = poi.category; // Keep lowercase
                    const name = poi.name || 'Unnamed POI'; // Default if no name
                    
                    cardsHtml += `
                        <div class="col">
                            <div class="card poi-card h-100">
                                <div class="card-body">
                                    <h5 class="card-title">${name}</h5>
                                    <h6 class="text-muted mb-2">
                                        <i class="bi ${icon} text-primary"></i>
                                        ${category}
                                    </h6>
                                    <p class="card-text">${details}</p>
                                    <div class="action-buttons mt-auto">
                                        <button type="button" class="btn btn-sm btn-outline-primary me-1" onclick="editPoi('${poi.href}')">
                                            <i class="bi bi-pencil"></i> Edit
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="deletePoi('${poi.href}')">
                                            <i class="bi bi-trash"></i> Delete
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                cardsHtml += '</div>';
                $container.html(cardsHtml);
                
                // Apply current filters after updating cards
                const nameFilter = $('#poiNameFilterInput').val() || '';
                const detailsFilter = $('#poiDetailsFilterInput').val() || '';
                if (typeof applyFilters === 'function') {
                    applyFilters(nameFilter, detailsFilter);
                }
            }
            
            function updatePoiTable(pois) {
                // Store the current POI list for sorting functionality
                currentTablePois = [...pois]; // create copy so we don't modify the original
                const $container = $('#poiTableContainer');
                
                if (!pois || pois.length === 0) {
                    $container.html(`
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle me-2"></i>
                            No points of interest found. Please adjust the search parameters and try again.
                        </div>
                    `);
                    return;
                }
                
                let tableHtml = `
                    <table class="table table-striped table-hover">
                        <thead class="table-primary">
                            <tr>
                                <th scope="col" style="cursor: pointer; user-select: none;" onclick="sortTable('name')">
                                    <i class="bi bi-tag me-2"></i>Name
                                    <i class="bi ${currentSortColumn === 'name' ? (sortAscending ? 'bi-sort-up' : 'bi-sort-down') : 'bi-arrow-down-up'} ms-1" style="opacity: ${currentSortColumn === 'name' ? '1' : '0.8'};"</i>
                                </th>
                                <th scope="col" class="category-cell-header" style="cursor: pointer; user-select: none;" onclick="sortTable('category')">
                                    <i class="bi bi-folder me-2"></i>Category
                                    <i class="bi ${currentSortColumn === 'category' ? (sortAscending ? 'bi-sort-up' : 'bi-sort-down') : 'bi-arrow-down-up'} ms-1" style="opacity: ${currentSortColumn === 'category' ? '1' : '0.8'};"</i>
                                </th>
                                <th scope="col" class="details-cell-header" style="cursor: pointer; user-select: none;" onclick="sortTable('details')">
                                    <i class="bi bi-info-circle me-2"></i>Details
                                    <i class="bi ${currentSortColumn === 'details' ? (sortAscending ? 'bi-sort-up' : 'bi-sort-down') : 'bi-arrow-down-up'} ms-1" style="opacity: ${currentSortColumn === 'details' ? '1' : '0.8'};"</i>
                                </th>
                                <th scope="col"><i class="bi bi-geo-alt me-2"></i>Location</th>
                                <th scope="col" style="width: 180px;"><i class="bi bi-gear me-2"></i>Action</th>
                            </tr>
                        </thead>
                        <tbody id="poiTableBody">
                `;
                
                pois.forEach((poi, index) => {
                    const icon = getCategoryIcon(poi.category);
                    const details = formatDetails(poi.details);
                    const category = poi.category; // Keep lowercase
                    const name = poi.name || 'Unnamed POI'; // Default if no name

                     // Format location coordinates
                    let locationHtml = '<span class="text-muted">No location</span>';
                    if (poi.location && poi.location.coordinates && poi.location.coordinates.length === 2) {
                        const lat = poi.location.coordinates[1].toFixed(6);
                        const lon = poi.location.coordinates[0].toFixed(6);
                        locationHtml = `Lat: ${lat}<br>Long: ${lon}`;
                    }
                    
                    tableHtml += `
                        <tr>
                            <td style="width: 200px;"><span class="lead" style="font-weight: 350;">${name}</span></td>
                            <td class="category-cell" style="width: 200px;"><i class="bi ${icon}"></i>${category}</td>
                            <td class="details-cell">${details}</td>
                            <td class="location-cell">${locationHtml}</td>
                            <td class="action-buttons">
                                <button type="button" class="btn btn-sm btn-outline-primary me-1" onclick="editPoi('${poi.href}')">
                                    <i class="bi bi-pencil"></i> Edit
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-danger" onclick="deletePoi('${poi.href}')">
                                    <i class="bi bi-trash"></i> Delete
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                tableHtml += `
                        </tbody>
                    </table>
                `;
                
                $container.html(tableHtml);
                
                // Apply current filters after updating table
                const nameFilter = $('#poiNameFilterInput').val() || '';
                const detailsFilter = $('#poiDetailsFilterInput').val() || '';
                if (typeof applyFilters === 'function') {
                    applyFilters(nameFilter, detailsFilter);
                }
            }
            
            function getCategoryIcon(category) {
                return CATEGORY_ICONS[category?.toLowerCase()] || CATEGORY_ICONS['_default'] || 'bi-geo';
            }
            
            function formatDetails(details) {
                if (!details) return '';
                
                let formatted = details;
                
                // Format phone numbers with icon (matching Razor FormatDetails logic)
                const phoneRegex = /\+\d[\d\s\-\(\)/]*,?/g;
                formatted = formatted.replace(phoneRegex, (match) => {
                    return `\n<i class='bi bi-telephone'></i> ${match}\n`;
                });

                // Format URLs/web links with icon
                // Matches http://, https://, www. and ftp:// links
                const urlRegex = /(https?:\/\/[^\s]+|www\.[^\s]+|ftp:\/\/[^\s]+)/gi;
                formatted = formatted.replace(urlRegex, (match) => {
                    const displayText = match.length > 40 ? match.substring(0, 37) + '...' : match;
                    return `<a href="${match}" target="_blank" rel="noopener noreferrer"><i class='bi bi-link-45deg'></i>${displayText}</a>`
                });
                // Replace newlines with <br>
                return formatted.replace(/\n/g, '<br>');
            }
            window.sortTable = function(column) {
                // If same column clicked: toggle sort headers
                // If different column clicked: start with ascending (A-Z)
                if (currentSortColumn === column) {
                    sortAscending = !sortAscending;
                } else {
                    currentSortColumn = column;
                    sortAscending = true;
                }
                // Sort the POI array based oncurrent column and direction
                currentTablePois.sort((a, b) => {
                    // Get values from specified column
                    let aVal, bVal;
                    if (column === 'name'){
                        aVal = a.name;
                        bVal = b.name;
                    } else if (column === 'category') {
                        aVal = a.category;
                        bVal = b.category;
                    } else if (column === 'details') {
                        aVal = a.details;
                        bVal = b.details;
                    }

                    // Handle null/undefined values - convert to empty string
                    aVal = (aVal || '').toString();
                    bVal = (bVal || '').toString();

                    // Use localeCompare for proper German sorting (umlauts)
                    const comparison = aVal.localeCompare(bVal, 'de-DE', {sensitivity: 'base', usage: 'sort' });
                    return sortAscending ? comparison : -comparison;
                });
                // Rerender the table with sorted data
                updatePoiTable(currentTablePois);
            }
        });
        
        // Store complete POI data for editing (needed for PUT request)
        let currentPoiData = null;
        
        // Global functions for onclick handlers
        function editPoi(href) {
            if (!href) {
                console.error('No href provided for edit');
                return;
            }
            
            // Show loading state
            const loadingHtml = `
                <div class="text-center">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            `;
            
            // Extract ID from href (last segment after /)
            const id = href.split('/').pop();
            
            // Fetch POI data
            $.ajax({
                url: href,
                type: 'GET',
                success: function(poi) {
                    // Store complete POI data (needed for PUT request)
                    currentPoiData = poi;
                    
                    // Store original data for change detection
                    originalPoiData = {
                        category: poi.category || '',
                        name: poi.name || '',
                        details: poi.details || ''
                    };
                    
                    // Populate form
                    $('#editPoiId').val(id);
                    $('#editPoiCategory').val(poi.category);
                    $('#editPoiName').val(poi.name);
                    $('#editPoiDetails').val(poi.details);
                    
                    // Display coordinates (read-only)
                    if (poi.location && poi.location.coordinates) {
                        const lon = poi.location.coordinates[0];
                        const lat = poi.location.coordinates[1];
                        $('#editPoiCoordinates').text(`${lat.toFixed(6)}, ${lon.toFixed(6)}`);
                    }
                    
                    // Reset validation states
                    $('#editPoiCategory').removeClass('is-invalid');
                    $('#editPoiName').removeClass('is-invalid');
                    $('#editPoiDetails').removeClass('is-invalid');
                    $('#saveEditBtn').prop('disabled', true);
                    
                    // Show modal
                    const modal = new bootstrap.Modal(document.getElementById('editPoiModal'));
                    modal.show();
                },
                error: function(xhr) {
                    console.error('Error loading POI:', xhr);
                    alert('Failed to load POI data. Please try again.');
                }
            });
        }
        
        function saveEditedPoi() {
            const id = $('#editPoiId').val();
            const category = $('#editPoiCategory').val().trim();
            const name = $('#editPoiName').val().trim();
            const details = $('#editPoiDetails').val().trim();
            
            if (!id || !category || !name || !details) {
                alert('Please fill in all required fields.');
                return;
            }
            
            if (!currentPoiData) {
                alert('POI data not loaded. Please try again.');
                return;
            }
            
            // Disable save button to prevent double submission
            $('#saveEditBtn').prop('disabled', true).html('<span class="spinner-border spinner-border-sm me-1"></span>Saving...');
            
            // Prepare update data - send complete POI object with updated fields
            const updateData = {
                category: category,
                name: name,
                details: details,
                location: currentPoiData.location,  // Keep location unchanged
                tags: currentPoiData.tags            // Keep tags if present
            };
            
            // Send PUT request to backend
            $.ajax({
                url: `/poi/${id}`,
                type: 'PUT',
                contentType: 'application/json',
                data: JSON.stringify(updateData),
                success: function(response) {
                    console.log('POI updated successfully:', response);
                    
                    // Hide modal
                    bootstrap.Modal.getInstance(document.getElementById('editPoiModal')).hide();
                    
                    // Reload POIs to show updated data
                    reloadCurrentPois();
                    
                    // Show success message
                    showSuccessMessage('POI updated successfully!');
                },
                error: function(xhr) {
                    console.error('Error updating POI:', xhr);
                    let errorMsg = 'Failed to update POI. Please try again.';
                    if (xhr.responseJSON && xhr.responseJSON.message) {
                        errorMsg = xhr.responseJSON.message;
                    }
                    alert(errorMsg);
                    $('#saveEditBtn').prop('disabled', false).text('Save (Enter)');
                }
            });
        }
        
        function deletePoi(href) {
            if (!href) {
                console.error('No href provided for delete');
                return;
            }
            
            if (confirm('Are you sure you want to delete this point of interest?')) {
                // Extract ID from href
                const id = href.split('/').pop();
                
                // Send DELETE request
                $.ajax({
                    url: `/poi/${id}`,
                    type: 'DELETE',
                    success: function() {
                        console.log('POI deleted successfully');
                        
                        // Reload POIs to update the view
                        reloadCurrentPois();
                        
                        // Show success message
                        showSuccessMessage('POI deleted successfully!');
                    },
                    error: function(xhr) {
                        console.error('Error deleting POI:', xhr);
                        alert('Failed to delete POI. Please try again.');
                    }
                });
            }
        }
        
        function reloadCurrentPois() {
            // Get current coordinates and radius
            const lat = parseFloat($('#latitudeInput').val());
            const lon = parseFloat($('#longitudeInput').val());
            const radius = parseInt($('#radiusInput').val());
            
            // Get selected categories
            const selectedCategories = CategoryManager.getSelectedCategories();
            
            // Build data object with categories
            const requestData = { 
                lat: lat, 
                lon: lon, 
                radius: radius 
            };
            
            // Add category parameters
            selectedCategories.forEach((category, index) => {
                requestData[`category[${index}]`] = category;
            });
            
            console.log('Reloading POIs with categories:', selectedCategories);
            
            // Reload POIs with current parameters
            $.ajax({
                url: '/api/pointsofinterest',
                method: 'GET',
                traditional: true,
                data: requestData,
                success: function(data) {
                    console.log(`Reloaded ${data.length} POIs`);
                    updatePoiCards(data);
                    updatePoiTable(data);
                },
                error: function() {
                    console.error('Failed to reload POIs');
                }
            });
        }
        
        function showSuccessMessage(message) {
            // Create a temporary success alert
            const alertHtml = `
                <div class="alert alert-success alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3" 
                     role="alert" style="z-index: 9999; min-width: 300px;">
                    <i class="bi bi-check-circle me-2"></i>${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            `;
            
            $('body').append(alertHtml);
            
            // Auto-remove after 3 seconds
            setTimeout(function() {
                $('.alert-success').alert('close');
            }, 3000);
        }
    </script>
}