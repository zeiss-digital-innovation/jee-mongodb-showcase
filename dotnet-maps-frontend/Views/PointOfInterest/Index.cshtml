@model List<DotNetMapsFrontend.Models.PointOfInterest>
@{
    ViewData["Title"] = "Point of Interest List";
}

<style>
    /* Fixed top controls */
    .top-controls {
        position: fixed;
        top: 56px; /* Height of navbar */
        left: 0;
        right: 0;
        background-color: white;
        padding: 15px 0;
        border-bottom: 1px solid #dee2e6;
        z-index: 1000;
    }
    
    /* Fixed header section */
    .poi-header-section {
        position: fixed;
        top: 178px; /* navbar (56px) + top-controls (~122px) */
        left: 0;
        right: 0;
        background-color: white;
        padding: 15px 0 15px 0;
        border-bottom: 2px solid #dee2e6;
        z-index: 999;
    }
    
    /* Scrollable content area */
    .poi-scrollable-content {
        position: fixed;
        top: 280px; /* navbar + controls + header + toggle */
        bottom: 0;
        left: 0;
        right: 0;
        overflow-y: auto;
        padding: 20px 0;
    }
    
    /* Table specific styles */
    .table-wrapper {
        position: relative;
    }
    
    .table thead th {
        position: sticky;
        top: 0;
        background-color: #212529;
        z-index: 998; /* Higher than content, lower than fixed headers */
        box-shadow: 0 2px 2px -1px rgba(0, 0, 0, 0.4);
    }
    
    .table td, .table th {
        vertical-align: middle;
    }
    
    .category-cell {
        text-transform: capitalize;
    }
    
    .details-cell {
        max-width: 500px;
        word-wrap: break-word;
    }
    
    .action-buttons {
        white-space: nowrap;
    }
    
    /* Card styles */
    .poi-card {
        transition: transform 0.2s;
        height: 100%;
    }
    
    .poi-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    
    .poi-card .card-body {
        display: flex;
        flex-direction: column;
    }
    
    .poi-card .card-title {
        display: flex;
        align-items: center;
        font-size: 1.25rem;
        margin-bottom: 1rem;
    }
    
    .poi-card .card-title i {
        font-size: 1.5rem;
        margin-right: 10px;
    }
    
    .poi-card .card-text {
        flex-grow: 1;
    }
    
    .view-toggle {
        margin-bottom: 0;
    }
    
    .view-toggle .btn-group {
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
</style>

<div class="top-controls fixed-top">
    <div class="container">
        <div class="row g-3">
            <div class="col-md-3">
                <label for="latitudeInput" class="form-label">Latitude (Range: -90 to 90)</label>
                <input type="number" class="form-control" id="latitudeInput" value="51.0504" step="0.0001" min="-90" max="90">
            </div>
            <div class="col-md-3">
                <label for="longitudeInput" class="form-label">Longitude (Range: -180 to 180)</label>
                <input type="number" class="form-control" id="longitudeInput" value="13.7373" step="0.0001" min="-180" max="180">
            </div>
            <div class="col-md-4">
                <label for="radiusInput" class="form-label">Radius <span id="radiusValue">2000</span> (m)</label>
                <input type="range" class="form-range" id="radiusInput" min="100" max="5000" value="2000" step="100">
            </div>
            <div class="col-md-2">
                <label class="form-label d-block">&nbsp;</label>
                <button type="button" class="btn btn-primary w-100" id="loadPoisBtn">
                    <i class="bi bi-arrow-clockwise me-1"></i>Load POIs
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Fixed Header Section -->
<div class="poi-header-section">
    <div class="container">
        <h2 class="mb-3">Points of Interest</h2>
        <!-- View Toggle -->
        <div class="view-toggle">
            <div class="btn-group" role="group" aria-label="View toggle">
                <button type="button" class="btn btn-outline-primary active" id="cardsViewBtn">
                    <i class="bi bi-grid-3x3-gap me-1"></i>Cards
                </button>
                <button type="button" class="btn btn-outline-primary" id="listViewBtn">
                    <i class="bi bi-list-ul me-1"></i>List
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Scrollable Content Area -->
<div class="poi-scrollable-content">
    <div class="container">
        <!-- Cards View (Default) -->
        <div id="poiCardsContainer">
        @if (Model != null && Model.Any())
        {
            <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
                @foreach (var poi in Model)
                {
                    <div class="col">
                        <div class="card poi-card h-100">
                            <div class="card-body">
                                <h5 class="card-title">
                                    <i class="bi @GetCategoryIcon(poi.Category) text-primary"></i>
                                    @poi.Category.ToLower()
                                </h5>
                                <p class="card-text">@Html.Raw(FormatDetails(poi.Details))</p>
                                <div class="action-buttons mt-auto">
                                    <button type="button" class="btn btn-sm btn-outline-primary me-1" onclick="editPoi('@poi.Href')">
                                        <i class="bi bi-pencil"></i> Edit
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="deletePoi('@poi.Href')">
                                        <i class="bi bi-trash"></i> Delete
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>
        }
        else
        {
            <div class="alert alert-info">
                <i class="bi bi-info-circle me-2"></i>
                No points of interest found. Please adjust the search parameters and click "Load POIs".
            </div>
        }
    </div>
    
    <!-- Table View (List) -->
    <div id="poiTableContainer" style="display: none;">
        @if (Model != null && Model.Any())
        {
            <table class="table table-striped table-hover">
                <thead class="table-dark">
                    <tr>
                        <th scope="col">Category</th>
                        <th scope="col">Details</th>
                        <th scope="col" style="width: 180px;">Action</th>
                    </tr>
                </thead>
                <tbody id="poiTableBody">
                    @for (int i = 0; i < Model.Count; i++)
                    {
                        var poi = Model[i];
                        <tr>
                            <td class="category-cell" style="width: 250px;">
                                @(i + 1). @poi.Category.ToLower() <i class="bi @GetCategoryIcon(poi.Category)"></i>
                            </td>
                            <td class="details-cell">@Html.Raw(FormatDetails(poi.Details))</td>
                            <td class="action-buttons">
                                <button type="button" class="btn btn-sm btn-outline-primary me-1" onclick="editPoi('@poi.Href')">
                                    <i class="bi bi-pencil"></i> Edit
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-danger" onclick="deletePoi('@poi.Href')">
                                    <i class="bi bi-trash"></i> Delete
                                </button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        }
        else
        {
            <div class="alert alert-info">
                <i class="bi bi-info-circle me-2"></i>
                No points of interest found. Please adjust the search parameters and click "Load POIs".
            </div>
        }
    </div>
    </div> <!-- End of container -->
</div> <!-- End of poi-scrollable-content -->

<!-- Edit POI Modal -->
<div class="modal fade" id="editPoiModal" tabindex="-1" aria-labelledby="editPoiModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editPoiModalLabel">Edit Point of Interest</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editPoiForm">
                    <input type="hidden" id="editPoiId">
                    
                    <div class="mb-3">
                        <label for="editPoiCategory" class="form-label">Category *</label>
                        <select class="form-select" id="editPoiCategory" required>
                            <option value="">-- Select Category --</option>
                        </select>
                        <div class="invalid-feedback">
                            Please select a category.
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="editPoiDetails" class="form-label">Details *</label>
                        <textarea class="form-control" id="editPoiDetails" rows="4" 
                                  placeholder="Enter details about this point of interest..." 
                                  required maxlength="1000"></textarea>
                        <div class="invalid-feedback">
                            Please enter details (max 1000 characters).
                        </div>
                        <div class="form-text">
                            You can use quotes, special characters, and line breaks.
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <small class="text-muted">
                            Location: <span id="editPoiCoordinates"></span> (read-only)
                        </small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="cancelEditBtn">
                    Cancel (Esc)
                </button>
                <button type="button" class="btn btn-primary" id="saveEditBtn" disabled>
                    Save (Enter)
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            // View toggle functionality
            let currentView = 'cards'; // Default view
            
            // Store original POI data for change detection
            let originalPoiData = {
                category: '',
                details: ''
            };
            
            // Load available categories on page load
            loadAvailableCategories();
            
            // Setup Edit Modal event handlers
            setupEditModalHandlers();
            
            function loadAvailableCategories() {
                $.ajax({
                    url: '/api/categories',
                    type: 'GET',
                    success: function (categories) {
                        populateCategoryDropdown(categories);
                    },
                    error: function (xhr, status, error) {
                        console.warn('Could not load categories from backend:', error);
                    }
                });
            }
            
            function populateCategoryDropdown(categories) {
                const $categorySelect = $('#editPoiCategory');
                $categorySelect.empty();
                $categorySelect.append('<option value="">-- Select Category --</option>');
                
                categories.forEach(function (category) {
                    // Value and display text both lowercase
                    const lowerCategory = category.toLowerCase();
                    $categorySelect.append(`<option value="${lowerCategory}">${lowerCategory}</option>`);
                });
            }
            
            function setupEditModalHandlers() {
                // Enable/disable save button based on form validation and changes
                $('#editPoiCategory, #editPoiDetails').on('input change', function () {
                    validateEditForm();
                });
                
                // Handle Save button click
                $('#saveEditBtn').click(function () {
                    if (validateEditForm() && hasChanges()) {
                        saveEditedPoi();
                    }
                });
                
                // Handle keyboard shortcuts
                $('#editPoiModal').on('keydown', function (e) {
                    if (e.key === 'Enter' && !e.shiftKey && e.target.tagName !== 'TEXTAREA') {
                        e.preventDefault();
                        if ($('#saveEditBtn').prop('disabled') === false) {
                            saveEditedPoi();
                        }
                    } else if (e.key === 'Escape') {
                        e.preventDefault();
                        bootstrap.Modal.getInstance(document.getElementById('editPoiModal')).hide();
                    }
                });
                
                // Allow Shift+Enter in textarea for new lines
                $('#editPoiDetails').on('keydown', function(e) {
                    if (e.key === 'Enter' && e.shiftKey) {
                        // Allow default behavior (new line)
                        return true;
                    } else if (e.key === 'Enter') {
                        e.preventDefault();
                        if ($('#saveEditBtn').prop('disabled') === false) {
                            saveEditedPoi();
                        }
                    }
                });
            }
            
            function validateEditForm() {
                const category = $('#editPoiCategory').val().trim();
                const details = $('#editPoiDetails').val().trim();
                const isValid = category !== '' && details !== '';
                const changed = hasChanges();
                
                $('#saveEditBtn').prop('disabled', !isValid || !changed);
                
                return isValid;
            }
            
            function hasChanges() {
                const currentCategory = $('#editPoiCategory').val().trim();
                const currentDetails = $('#editPoiDetails').val().trim();
                
                return currentCategory !== originalPoiData.category || 
                       currentDetails !== originalPoiData.details;
            }
            
            $('#cardsViewBtn').click(function() {
                currentView = 'cards';
                $(this).addClass('active');
                $('#listViewBtn').removeClass('active');
                $('#poiCardsContainer').show();
                $('#poiTableContainer').hide();
            });
            
            $('#listViewBtn').click(function() {
                currentView = 'list';
                $(this).addClass('active');
                $('#cardsViewBtn').removeClass('active');
                $('#poiCardsContainer').hide();
                $('#poiTableContainer').show();
            });
            
            // Update radius display when slider changes
            $('#radiusInput').on('input', function() {
                $('#radiusValue').text($(this).val());
            });
            
            // Validate coordinates
            function validateCoordinates() {
                const lat = parseFloat($('#latitudeInput').val());
                const lon = parseFloat($('#longitudeInput').val());
                const radius = parseInt($('#radiusInput').val());
                
                const latValid = !isNaN(lat) && lat >= -90 && lat <= 90;
                const lonValid = !isNaN(lon) && lon >= -180 && lon <= 180;
                const radiusValid = !isNaN(radius) && radius >= 100 && radius <= 5000;
                
                return latValid && lonValid && radiusValid;
            }
            
            // Update button state based on validation
            function updateButtonState() {
                $('#loadPoisBtn').prop('disabled', !validateCoordinates());
            }
            
            $('#latitudeInput, #longitudeInput, #radiusInput').on('input', updateButtonState);
            updateButtonState();
            
            // Load POIs button click handler
            $('#loadPoisBtn').click(function() {
                const lat = parseFloat($('#latitudeInput').val());
                const lon = parseFloat($('#longitudeInput').val());
                const radius = parseInt($('#radiusInput').val());
                
                if (!validateCoordinates()) {
                    alert('Please enter valid coordinates and radius.');
                    return;
                }
                
                // Show loading state
                const $btn = $(this);
                const originalHtml = $btn.html();
                $btn.html('<span class="spinner-border spinner-border-sm me-1"></span>Loading...').prop('disabled', true);
                
                // Make AJAX request
                $.ajax({
                    url: '/api/pointsofinterest',
                    method: 'GET',
                    data: { lat: lat, lon: lon, radius: radius },
                    success: function(data) {
                        // Update both views with new data
                        updatePoiCards(data);
                        updatePoiTable(data);
                    },
                    error: function() {
                        alert('Failed to load points of interest. Please try again.');
                    },
                    complete: function() {
                        $btn.html(originalHtml).prop('disabled', false);
                        updateButtonState();
                    }
                });
            });
            
            // Make these functions available globally for reloadCurrentPois
            window.updatePoiCards = updatePoiCards;
            window.updatePoiTable = updatePoiTable;
            
            function updatePoiCards(pois) {
                const $container = $('#poiCardsContainer');
                
                if (!pois || pois.length === 0) {
                    $container.html(`
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle me-2"></i>
                            No points of interest found. Please adjust the search parameters and try again.
                        </div>
                    `);
                    return;
                }
                
                let cardsHtml = '<div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">';
                
                pois.forEach((poi) => {
                    const icon = getCategoryIcon(poi.category);
                    const details = formatDetails(poi.details);
                    const category = poi.category; // Keep lowercase
                    
                    cardsHtml += `
                        <div class="col">
                            <div class="card poi-card h-100">
                                <div class="card-body">
                                    <h5 class="card-title">
                                        <i class="bi ${icon} text-primary"></i>
                                        ${category}
                                    </h5>
                                    <p class="card-text">${details}</p>
                                    <div class="action-buttons mt-auto">
                                        <button type="button" class="btn btn-sm btn-outline-primary me-1" onclick="editPoi('${poi.href}')">
                                            <i class="bi bi-pencil"></i> Edit
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="deletePoi('${poi.href}')">
                                            <i class="bi bi-trash"></i> Delete
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                cardsHtml += '</div>';
                $container.html(cardsHtml);
            }
            
            function updatePoiTable(pois) {
                const $container = $('#poiTableContainer');
                
                if (!pois || pois.length === 0) {
                    $container.html(`
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle me-2"></i>
                            No points of interest found. Please adjust the search parameters and try again.
                        </div>
                    `);
                    return;
                }
                
                let tableHtml = `
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th scope="col">Category</th>
                                <th scope="col">Details</th>
                                <th scope="col" style="width: 180px;">Action</th>
                            </tr>
                        </thead>
                        <tbody id="poiTableBody">
                `;
                
                pois.forEach((poi, index) => {
                    const icon = getCategoryIcon(poi.category);
                    const details = formatDetails(poi.details);
                    const category = poi.category; // Keep lowercase
                    
                    tableHtml += `
                        <tr>
                            <td class="category-cell" style="width: 250px;">${index + 1}. ${category} <i class="bi ${icon}"></i></td>
                            <td class="details-cell">${details}</td>
                            <td class="action-buttons">
                                <button type="button" class="btn btn-sm btn-outline-primary me-1" onclick="editPoi('${poi.href}')">
                                    <i class="bi bi-pencil"></i> Edit
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-danger" onclick="deletePoi('${poi.href}')">
                                    <i class="bi bi-trash"></i> Delete
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                tableHtml += `
                        </tbody>
                    </table>
                `;
                
                $container.html(tableHtml);
            }
            
            function getCategoryIcon(category) {
                const icons = {
                    'restaurant': 'bi-cup-hot',
                    'cash': 'bi-credit-card',
                    'supermarket': 'bi-shop',
                    'post': 'bi-mailbox',
                    'lodging': 'bi-house',
                    'police': 'bi-shield-check',
                    'toilet': 'bi-person-standing',
                    'coffee': 'bi-cup-hot',
                    'parking': 'bi-car-front',
                    'gas station': 'bi-fuel-pump',
                    'company': 'bi-building',
                    'pharmacy': 'bi-plus-square'
                };
                return icons[category?.toLowerCase()] || 'bi-geo-alt';
            }
            
            function formatDetails(details) {
                if (!details) return '';
                return details.replace(/\n/g, '<br>');
            }
        });
        
        // Store complete POI data for editing (needed for PUT request)
        let currentPoiData = null;
        
        // Global functions for onclick handlers
        function editPoi(href) {
            if (!href) {
                console.error('No href provided for edit');
                return;
            }
            
            // Show loading state
            const loadingHtml = `
                <div class="text-center">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            `;
            
            // Extract ID from href (last segment after /)
            const id = href.split('/').pop();
            
            // Fetch POI data
            $.ajax({
                url: href,
                type: 'GET',
                success: function(poi) {
                    // Store complete POI data (needed for PUT request)
                    currentPoiData = poi;
                    
                    // Store original data for change detection
                    originalPoiData = {
                        category: poi.category || '',
                        details: poi.details || ''
                    };
                    
                    // Populate form
                    $('#editPoiId').val(id);
                    $('#editPoiCategory').val(poi.category);
                    $('#editPoiDetails').val(poi.details);
                    
                    // Display coordinates (read-only)
                    if (poi.location && poi.location.coordinates) {
                        const lon = poi.location.coordinates[0];
                        const lat = poi.location.coordinates[1];
                        $('#editPoiCoordinates').text(`${lat.toFixed(6)}, ${lon.toFixed(6)}`);
                    }
                    
                    // Reset validation states
                    $('#editPoiCategory').removeClass('is-invalid');
                    $('#editPoiDetails').removeClass('is-invalid');
                    $('#saveEditBtn').prop('disabled', true);
                    
                    // Show modal
                    const modal = new bootstrap.Modal(document.getElementById('editPoiModal'));
                    modal.show();
                },
                error: function(xhr) {
                    console.error('Error loading POI:', xhr);
                    alert('Failed to load POI data. Please try again.');
                }
            });
        }
        
        function saveEditedPoi() {
            const id = $('#editPoiId').val();
            const category = $('#editPoiCategory').val().trim();
            const details = $('#editPoiDetails').val().trim();
            
            if (!id || !category || !details) {
                alert('Please fill in all required fields.');
                return;
            }
            
            if (!currentPoiData) {
                alert('POI data not loaded. Please try again.');
                return;
            }
            
            // Disable save button to prevent double submission
            $('#saveEditBtn').prop('disabled', true).html('<span class="spinner-border spinner-border-sm me-1"></span>Saving...');
            
            // Prepare update data - send complete POI object with updated fields
            const updateData = {
                category: category,
                details: details,
                location: currentPoiData.location,  // Keep location unchanged
                name: currentPoiData.name,           // Keep name if present
                tags: currentPoiData.tags            // Keep tags if present
            };
            
            // Send PUT request to backend
            $.ajax({
                url: `/poi/${id}`,
                type: 'PUT',
                contentType: 'application/json',
                data: JSON.stringify(updateData),
                success: function(response) {
                    console.log('POI updated successfully:', response);
                    
                    // Hide modal
                    bootstrap.Modal.getInstance(document.getElementById('editPoiModal')).hide();
                    
                    // Reload POIs to show updated data
                    reloadCurrentPois();
                    
                    // Show success message
                    showSuccessMessage('POI updated successfully!');
                },
                error: function(xhr) {
                    console.error('Error updating POI:', xhr);
                    let errorMsg = 'Failed to update POI. Please try again.';
                    if (xhr.responseJSON && xhr.responseJSON.message) {
                        errorMsg = xhr.responseJSON.message;
                    }
                    alert(errorMsg);
                    $('#saveEditBtn').prop('disabled', false).text('Save (Enter)');
                }
            });
        }
        
        function deletePoi(href) {
            if (!href) {
                console.error('No href provided for delete');
                return;
            }
            
            if (confirm('Are you sure you want to delete this point of interest?')) {
                // Extract ID from href
                const id = href.split('/').pop();
                
                // Send DELETE request
                $.ajax({
                    url: `/poi/${id}`,
                    type: 'DELETE',
                    success: function() {
                        console.log('POI deleted successfully');
                        
                        // Reload POIs to update the view
                        reloadCurrentPois();
                        
                        // Show success message
                        showSuccessMessage('POI deleted successfully!');
                    },
                    error: function(xhr) {
                        console.error('Error deleting POI:', xhr);
                        alert('Failed to delete POI. Please try again.');
                    }
                });
            }
        }
        
        function reloadCurrentPois() {
            // Get current coordinates and radius
            const lat = parseFloat($('#latitudeInput').val());
            const lon = parseFloat($('#longitudeInput').val());
            const radius = parseInt($('#radiusInput').val());
            
            // Reload POIs with current parameters
            $.ajax({
                url: '/api/pointsofinterest',
                method: 'GET',
                data: { lat: lat, lon: lon, radius: radius },
                success: function(data) {
                    updatePoiCards(data);
                    updatePoiTable(data);
                },
                error: function() {
                    console.error('Failed to reload POIs');
                }
            });
        }
        
        function showSuccessMessage(message) {
            // Create a temporary success alert
            const alertHtml = `
                <div class="alert alert-success alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3" 
                     role="alert" style="z-index: 9999; min-width: 300px;">
                    <i class="bi bi-check-circle me-2"></i>${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            `;
            
            $('body').append(alertHtml);
            
            // Auto-remove after 3 seconds
            setTimeout(function() {
                $('.alert-success').alert('close');
            }, 3000);
        }
    </script>
}

@functions {
    string GetCategoryIcon(string category)
    {
        return category?.ToLower() switch
        {
            "restaurant" => "bi-cup-hot",
            "cash" => "bi-credit-card",
            "supermarket" => "bi-shop",
            "post" => "bi-mailbox",
            "lodging" => "bi-house",
            "police" => "bi-shield-check",
            "toilet" => "bi-person-standing",
            "coffee" => "bi-cup-hot",
            "parking" => "bi-car-front",
            "gas station" => "bi-fuel-pump",
            "company" => "bi-building",
            "pharmacy" => "bi-plus-square",
            _ => "bi-geo-alt"
        };
    }
    
    string FormatDetails(string details)
    {
        if (string.IsNullOrEmpty(details))
            return string.Empty;
            
        return details.Replace("\n", "<br>");
    }
}